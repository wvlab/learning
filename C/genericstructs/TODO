TODO: Tests, a lot of tests